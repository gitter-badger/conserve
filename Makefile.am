AUTOMAKE_OPTIONS = foreign subdir-objects

ACLOCAL_AMFLAGS = -I acinclude

bin_PROGRAMS = conserve

check: cram-tests

CXXFLAGS += -Wall

LDADD=-lprotobuf -lboost_filesystem -lboost_system -lglog -lbz2

nodist_conserve_SOURCES = proto/conserve.pb.cc

BUILT_SOURCES = proto/conserve.capnp.c++ \
	proto/conserve.capnp.h

conserve_SOURCES = \
	src/archive.cc \
	src/archive.h \
	src/backup.cc \
	src/backup.h \
	src/band.cc \
	src/band.h \
	src/block.cc \
	src/block.h \
	src/blockreader.cc \
	src/blockreader.h \
	src/blockwriter.cc \
	src/blockwriter.h \
	src/bzdatawriter.cc \
	src/bzdatawriter.h \
	src/conserve.cc \
	src/datareader.cc \
	src/datareader.h \
	src/exitcode.h \
	src/filecopy.cc \
	src/filecopy.h \
	src/printproto.cc \
	src/printproto.h \
	src/problem.cc \
	src/problem.h \
	src/restore.cc \
	src/restore.h \
	src/util.cc \
	src/util.h \
	src/validate.cc \
	src/validate.h

proto/conserve.capnp.c++ proto/conserve.capnp.h: proto/conserve.capnp
	capnp compile -oc++:. $<

check-staged:
	t=`mktemp -d` && \
	echo check-staged in "$$t" && \
	cd $(srcdir) && git checkout-index --prefix "$$t/" -a && \
	cd "$$t" && \
	./autogen.sh && \
	mkdir _build && cd _build && \
	../configure && \
	$(MAKE) $(MAKEFLAGS) distcheck && \
	rm -r "$$t"

CRAM_OPTIONS = --indent=4 -v

cram-tests: conserve $(cram_tests)
	PATH=`pwd`:$$PATH cram $(CRAM_OPTIONS) $(srcdir)/tests/*md

update-cram: conserve $(cram_tests)
	PATH=`pwd`:$$PATH cram $(CRAM_OPTIONS) -i $(srcdir)/tests/*md

CLEANFILES = proto/conserve.capnp.c++ proto/conserve.capnp.h

EXTRA_DIST = \
	proto/conserve.proto \
	$(cram_tests)

cram_tests = \
	tests/backup.md \
	tests/hello.md \
	tests/help.md \
	tests/printproto.md


man/conserve.1: man/conserve.asciidoc
	a2x -vv -f manpage $<

show-manpage: man/conserve.1
	man $<
